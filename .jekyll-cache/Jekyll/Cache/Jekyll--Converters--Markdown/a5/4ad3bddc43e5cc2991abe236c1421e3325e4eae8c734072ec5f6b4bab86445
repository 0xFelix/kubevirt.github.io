I"Ú<p>As of Kubernetes 1.10, the Device Plugins API is now in beta! KubeVirt is now
using this framework to provide hardware acceleration and network devices to
virtual machines. The motivation behind this is that virt-launcher pods are no
longer responsible for creating their own device nodes. Or stated another way:
virt-launcher pods no longer require excess privileges just for the purpose of
creating device nodes.</p>

<h2 id="kubernetes-device-plugin-basics">Kubernetes Device Plugin Basics</h2>

<p>Device Plugins consist of two main parts: a server that provides devices and
pods that consume them. Each plugin server is used to share a preconfigured
list of devices local to the node with pods scheduled on that node. Kubernetes
marks each node with the devices itâ€™s capable of sharing, and uses the presence
of such devices when scheduling pods.</p>

<h2 id="device-plugins-in-kubevirt">Device Plugins In KubeVirt</h2>

<h3 id="providing-devices">Providing Devices</h3>

<p>In KubeVirt virt-handler takes on the role of the device plugin server. When it
starts up on each node, it registers with the Kubernetes Device Plugin API and
advertises KVM and TUN devices.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Node</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="s">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="s">...</span>
<span class="na">status</span><span class="pi">:</span>
  <span class="na">allocatable</span><span class="pi">:</span>
    <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
    <span class="s">devices.kubevirt.io/kvm</span><span class="pi">:</span> <span class="s2">"</span><span class="s">110"</span>
    <span class="s">devices.kubevirt.io/tun</span><span class="pi">:</span> <span class="s2">"</span><span class="s">110"</span>
    <span class="na">pods</span><span class="pi">:</span> <span class="s2">"</span><span class="s">110"</span>
    <span class="s">...</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
    <span class="s">devices.kubevirt.io/kvm</span><span class="pi">:</span> <span class="s2">"</span><span class="s">110"</span>
    <span class="s">devices.kubevirt.io/tun</span><span class="pi">:</span> <span class="s2">"</span><span class="s">110"</span>
    <span class="na">pods</span><span class="pi">:</span> <span class="s2">"</span><span class="s">110"</span>
    <span class="s">...</span>
</code></pre></div></div>

<p>In this case advertising 110 KVM or TUN devices is simply an arbitrary default
based on the number of pods that node is limited to.</p>

<h3 id="consuming-devices">Consuming Devices</h3>

<p>Now any pod that requests a <code class="highlighter-rouge">devices.kubevirt.io/kvm</code> or
<code class="highlighter-rouge">devices.kubevirt.io/tun</code> device can only be scheduled on nodes which provide
them. On clusters where KubeVirt is deployed this conveniently happens to be
all nodes in the cluster that have these physical devices, which normally means
all nodes in the cluster.</p>

<p>Hereâ€™s an excerpt of what the pod spec looks like in this case.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="s">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/entrypoint.sh</span>
      <span class="s">...</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">compute</span>
      <span class="s">...</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="s">devices.kubevirt.io/kvm</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
        <span class="s">devices.kubevirt.io/tun</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="s">devices.kubevirt.io/kvm</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
        <span class="s">devices.kubevirt.io/tun</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">161679432"</span>
    <span class="na">securityContext</span><span class="pi">:</span>
      <span class="na">capabilities</span><span class="pi">:</span>
        <span class="na">add</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">NET_ADMIN</span>
      <span class="na">privileged</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">0</span>
    <span class="s">...</span>
</code></pre></div></div>

<p>Of special note is the securityContext stanza. The only special privilege
required is the <code class="highlighter-rouge">NET_ADMIN</code> capability! This is needed by libvirt to set up the
domainâ€™s networking stack.</p>
:ET