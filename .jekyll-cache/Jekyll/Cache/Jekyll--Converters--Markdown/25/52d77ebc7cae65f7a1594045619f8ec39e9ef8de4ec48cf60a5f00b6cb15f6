I"'<h1 id="introduction">Introduction</h1>

<p>Vagrant is a command line utility for managing the lifecycle of virtual machines. There are number of providers available which allow to control and provision virtual machines in different environment. In this blog post we update how to use the <a href="https://github.com/pkliczewski/vagrant-kubevirt">provider</a> to manage <a href="https://kubevirt.io/">KubeVirt</a>.</p>

<p>The KubeVirt Vagrant provider implements the following features:</p>

<ul>
  <li>Manages virtual machines lifecycle - start, halt, status and destroy.</li>
  <li>Creates virtual machines using templates, container disks or existing pvc.</li>
  <li>Supports Vagrant built-in provisioners.</li>
  <li>Provides ability to ssh to the virtual machines</li>
  <li>Supports folder synchronization by using rsync</li>
</ul>

<h1 id="installation">Installation</h1>

<p>In order to use the provider we need to install Vagrant first. The steps how to do it are available <a href="https://www.vagrantup.com/intro/getting-started/install.html">here</a>. Once command line tool is available in our system, we can install the plugin by running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vagrant plugin install vagrant-kubevirt
</code></pre></div></div>

<p>Now, we can obtain predefined box and start it using:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vagrant up --provider=kubevirt
</code></pre></div></div>

<h1 id="virtual-machine-definition">Virtual machine definition</h1>

<p>Instead of building a virtual machine from scratch, which would be a slow and tedious process, Vagrant uses a base image as template for virtual machines. These base images are known as “boxes” and every provider must introduce its own box format. The provider introduces <em>kubevirt</em> boxes.
You can view an example box <a href="https://github.com/pkliczewski/vagrant-kubevirt/blob/master/example_box/">here</a>.</p>

<p>There are two ways to tell Vagrant, how to connect to KubeVirt cluster in Vagrantfile:</p>

<ul>
  <li>use Kubernetes configuration file. When no other connection details provided, the provider will look for kubeconfig using value of KUBECONFIG environment variable or $HOME/.kube/config location.</li>
  <li>define connection details as part of box definition</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:kubevirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">kubevirt</span><span class="o">|</span>
    <span class="n">kubevirt</span><span class="p">.</span><span class="nf">hostname</span> <span class="o">=</span> <span class="s1">'&lt;kubevirt host&gt;'</span>
    <span class="n">kubevirt</span><span class="p">.</span><span class="nf">port</span> <span class="o">=</span> <span class="s1">'&lt;kubevirt port&gt;'</span>
    <span class="n">kubevirt</span><span class="p">.</span><span class="nf">token</span> <span class="o">=</span> <span class="s1">'&lt;token&gt;'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Values used in above sample box:</p>

<ul>
  <li>kubevirt host - Hostname where KubeVirt is deployed</li>
  <li>kubevirt port - Port on where KubeVirt is listening</li>
  <li>token - User token used to authenticate any request</li>
</ul>

<p>There are number of options we can customize for specific a virtal machine:</p>

<ul>
  <li>cpus - Number of cpus used by a virtual machine</li>
  <li>memory - Amount of memory by a virtual machine</li>
</ul>

<p>We can choose one of the three following options:</p>

<ul>
  <li>template - Name of a template which will be used to create the virtual machine</li>
  <li>image - Name of a container disk stored in a registry</li>
  <li>pvc - Name of persistent volume claim containing virtual machine disk</li>
</ul>

<p>Below, you can find sample Vagrantfile exposing all the supported features:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># name of the box</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s1">'kubevirt'</span>
  <span class="c1"># vm boot timeout</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">boot_timeout</span> <span class="o">=</span> <span class="mi">360</span>

  <span class="c1"># disables default vagrant folder</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">true</span>
  <span class="c1"># synchoronizes a directory between a host and virtual machine</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"$HOME/src"</span><span class="p">,</span> <span class="s2">"/srv/website"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"rsync"</span>

  <span class="c1"># uses provision action to touch a file in a virtual machine</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">inline</span> <span class="o">=</span> <span class="s2">"touch example.txt"</span>
  <span class="k">end</span>

  <span class="c1"># defines virtual machine resources and source of disk</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:kubevirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">kubevirt</span><span class="o">|</span>
    <span class="n">kubevirt</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">kubevirt</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">kubevirt</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="s1">'kubevirt/fedora-cloud-registry-disk-demo'</span>
  <span class="k">end</span>

  <span class="c1"># defines a user configured on a virtual machine using cloud-init</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">ssh</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="s1">'vagrant'</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">ssh</span><span class="p">.</span><span class="nf">password</span> <span class="o">=</span> <span class="s1">'vagrant'</span>
<span class="k">end</span>
</code></pre></div></div>

<h1 id="usage">Usage</h1>

<p>Now, once we defined a virtual machine we can see how to use the provider to manage it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant up
</code></pre></div></div>

<p>The above command starts a virtual machines and performs any additonal operations defined in the Vagrantfile like provisioning, folder synchronization setup. For more information check <a href="https://www.vagrantup.com/docs/cli/up.html">here</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant halt
</code></pre></div></div>

<p>The above command stops a virtual machine. For more information check <a href="https://www.vagrantup.com/docs/cli/halt.html">here</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant status
</code></pre></div></div>

<p>The above command provides status of a virtual machine. For more information check <a href="https://www.vagrantup.com/docs/cli/status.html">here</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant destroy
</code></pre></div></div>

<p>The above command stops a virtual machine and destroys all the resources used. For more information check <a href="https://www.vagrantup.com/docs/cli/destroy.html">here</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant provision
</code></pre></div></div>

<p>The above command runs configured provisioners for specific virtual machine. For more information check <a href="https://www.vagrantup.com/docs/cli/provision.html">here</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant ssh
</code></pre></div></div>

<p>The above command ssh to running virtual machine. For more information check <a href="https://www.vagrantup.com/docs/cli/ssh.html">here</a></p>

<h1 id="future-work">Future work</h1>

<p>There are still couple of features we would like to implement such as network management or user friendly box packaging.</p>
:ET