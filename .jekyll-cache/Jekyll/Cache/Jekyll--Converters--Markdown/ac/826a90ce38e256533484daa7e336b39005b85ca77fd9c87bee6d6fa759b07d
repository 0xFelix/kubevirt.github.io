I"3!<h2 id="introduction">Introduction</h2>

<p>Recently three new volume types were introduced, which can be used for additional VM disks, and allow better integration of virtual machines with
well known Kubernetes resources.</p>

<h2 id="configmap-and-secret">ConfigMap and Secret</h2>

<p>Both <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMaps</a>
and <a href="https://kubernetes.io/docs/tasks/inject-data-application/distribute-credentials-secure/">Secrets</a> are used to provide configuration settings and credentials to Pods. In order to use them in your VM too, you can add them as additional disks, using the new <code class="highlighter-rouge">configMap</code>
and <code class="highlighter-rouge">secret</code> volume types.</p>

<h2 id="serviceaccount">ServiceAccount</h2>

<p>Kubernetes pods can be configured to get a special type of secret injected, which can be used for
<a href="https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/#accessing-the-api-from-a-pod">accessing the Kubernetes API</a>.
With the third new volume type <code class="highlighter-rouge">serviceAccount</code> you can get this information into your VM, too.</p>

<h2 id="example">Example</h2>

<p>We assume that you already have a Kubernetes or OpenShift cluster running with KubeVirt installed.</p>

<h3 id="step-1">Step 1</h3>

<p>Create a ConfigMap and Secret, which will be used in your VM:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl create secret generic mysecret --from-literal=PASSWORD=hidden
secret "mysecret" created
$ kubectl create configmap myconfigmap --from-literal=DATABASE=staging
configmap "myconfigmap" created
</code></pre></div></div>

<h3 id="step-2">Step 2</h3>

<p>Define a VirtualMachineInstance which uses all three new volume types, and save it to <code class="highlighter-rouge">vmi-fedora.yaml</code>.
Note how we add 3 disks for the ConfigMap and Secret we just created, and for the <code class="highlighter-rouge">default</code> ServiceAccount.
In order to automount these disks, we also add a <code class="highlighter-rouge">cloudInitNoCloud</code> disk with mount instructions. Details on
how to do this might vary depending on the VMâ€™s operating system.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubevirt.io/v1alpha2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualMachineInstance</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vmi-fedora</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">domain</span><span class="pi">:</span>
    <span class="na">devices</span><span class="pi">:</span>
      <span class="na">disks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">registrydisk</span>
          <span class="na">volumeName</span><span class="pi">:</span> <span class="s">registryvolume</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudinitdisk</span>
          <span class="na">volumeName</span><span class="pi">:</span> <span class="s">cloudinitvolume</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">configmap-disk</span>
          <span class="na">serial</span><span class="pi">:</span> <span class="s">configmap</span>
          <span class="na">volumeName</span><span class="pi">:</span> <span class="s">configmap-volume</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">secret-disk</span>
          <span class="na">serial</span><span class="pi">:</span> <span class="s">secret</span>
          <span class="na">volumeName</span><span class="pi">:</span> <span class="s">secret-volume</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">serviceaccount-disk</span>
          <span class="na">serial</span><span class="pi">:</span> <span class="s">serviceaccount</span>
          <span class="na">volumeName</span><span class="pi">:</span> <span class="s">serviceaccount-volume</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">1024M</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">registryvolume</span>
      <span class="na">registryDisk</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">kubevirt/fedora-cloud-registry-disk-demo:latest</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudinitvolume</span>
      <span class="na">cloudInitNoCloud</span><span class="pi">:</span>
        <span class="na">userData</span><span class="pi">:</span> <span class="pi">|-</span>
          <span class="s">#cloud-config</span>
          <span class="s">password: fedora</span>
          <span class="s">chpasswd: { expire: False }</span>
          <span class="s">bootcmd:</span>
            <span class="s"># mount the disks</span>
            <span class="s">- "mkdir /mnt/{myconfigmap,mysecret,myserviceaccount}"</span>
            <span class="s">- "mount /dev/disk/by-id/ata-QEMU_HARDDISK_configmap /mnt/myconfigmap"</span>
            <span class="s">- "mount /dev/disk/by-id/ata-QEMU_HARDDISK_secret /mnt/mysecret"</span>
            <span class="s">- "mount /dev/disk/by-id/ata-QEMU_HARDDISK_serviceaccount /mnt/myserviceaccount"</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">configmap-volume</span>
      <span class="na">configMap</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">myconfigmap</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">secret-volume</span>
      <span class="na">secret</span><span class="pi">:</span>
        <span class="na">secretName</span><span class="pi">:</span> <span class="s">mysecret</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">serviceaccount-volume</span>
      <span class="na">serviceAccount</span><span class="pi">:</span>
        <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">default</span>
</code></pre></div></div>

<h3 id="step-3">Step 3</h3>

<p>Create the VMI:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> vmi-fedora.yaml
virtualmachineinstance <span class="s2">"vmi-fedora"</span> created
</code></pre></div></div>

<h3 id="step-4">Step 4</h3>

<p>Inspect the new disks:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>virtctl console vmi-fedora

vmi-fedora login: fedora
Password:

<span class="o">[</span>fedora@vmi-fedora ~]<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-R</span> /mnt/
/mnt/:
myconfigmap  mysecret  myserviceaccount

/mnt/myconfigmap:
DATABASE

/mnt/mysecret:
PASSWORD

/mnt/myserviceaccount:
ca.crt	namespace  token

<span class="o">[</span>fedora@vmi-fedora ~]<span class="nv">$ </span><span class="nb">cat</span> /mnt/myconfigmap/DATABASE
staging

<span class="o">[</span>fedora@vmi-fedora ~]<span class="nv">$ </span><span class="nb">cat</span> /mnt/mysecret/PASSWORD
hidden

<span class="o">[</span>fedora@vmi-fedora ~]<span class="nv">$ </span><span class="nb">cat</span> /mnt/myserviceaccount/namespace
default
</code></pre></div></div>

<h2 id="summary">Summary</h2>

<p>With these new volume types KubeVirt further improves the integration with native Kubernetes resources.
Learn more about all available volume types on the <a href="https://kubevirt.io/user-guide/#/workloads/virtual-machines/disks-and-volumes">userguide</a>.</p>
:ET