I"å
<p>This blog post follow my previous research on how to allow vms inside a k8s cluster tp play nice with istio and other sidecars.</p>

<h1 id="research-conclusions-and-network-roadmap">Research conclusions and network roadmap</h1>

<p>After the deep research about different options/ways to connect VM to pods, we find that all the solution have different pros and cons.
All the represented solution need access to kernel modules and have the risk of conflicting with other networking tools.</p>

<p>We decided to implement a 100% Kubernetes compatible network approach on the KubeVirt project by using the slirp interface qemu provides.
This approach let the VM (from a networking perspective) behave like a process. Thus all traffic is going in and out of TCP or UDP sockets. The approach especially needs to avoid to rely on any specific Kernel configurations (like iptables, ebtables, tc, â€¦) in order to not conflict with other Kubernetes networking tools like Istio or multus.</p>

<p>This is just an intermediate solution, because itâ€™s shortcomings (unmaintained, unsafe, not performing well)</p>

<h3 id="slirp-interface">Slirp interface</h3>

<p>Pros:</p>

<ul>
  <li>vm ack like a process</li>
  <li>No external modules needed</li>
  <li>No external process needed</li>
  <li>Works with any sidecar solution</li>
  <li>no rely on any specific Kernel configurations</li>
  <li>pod can run without privilege</li>
</ul>

<p>Cons:</p>

<ul>
  <li>poor performance</li>
  <li>use userspace network stack</li>
</ul>

<h3 id="iptables-only">Iptables only</h3>

<p>Pros:</p>

<ul>
  <li>No external modules needed</li>
  <li>No external process needed</li>
  <li>All the traffic is handled by the kernel user space not involved</li>
</ul>

<p>Cons:</p>

<ul>
  <li><span style="color:red;">Istio dedicated solution!</span></li>
  <li>Not other process can change the iptables rules</li>
</ul>

<h3 id="iptables-with-a-nat-proxy">Iptables with a nat-proxy</h3>

<p>Pros:</p>

<ul>
  <li>No external modules needed</li>
  <li>Works with any sidecar solution</li>
</ul>

<p>Cons:</p>

<ul>
  <li>Not other process can change the iptables rules</li>
  <li>External process needed</li>
  <li>The traffic is passed to user space</li>
  <li>Only support ingress TCP connection</li>
</ul>

<h3 id="iptables-with-a-trasperent-proxy">Iptables with a trasperent-proxy</h3>

<p>Pros:</p>

<ul>
  <li>other process can change the nat table (this solution works on the mangle table)</li>
  <li>better preformance comparing to nat-proxy</li>
  <li>Works with any sidecar solution</li>
</ul>

<p>Cons:</p>

<ul>
  <li>Need NET_ADMIN capability for the docker</li>
  <li>External process needed</li>
  <li>The traffic is passed to user space</li>
  <li>Only support ingress TCP connection</li>
</ul>
:ET